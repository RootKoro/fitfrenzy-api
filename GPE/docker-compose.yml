version: '3.9'

services:
    #Back
    nest:
        container_name: nestjs_api_dev
        image: nestjs-api-dev:1.0.0
        build:
            context: .
            target: development
            dockerfile: api/Dockerfile
        command: npm run start:debug
        ports:
            - 3000:3000
            - 9229:9229
        networks:
            - nesjs-network
        volumes:
            - .:/usr/src/app/api
            - /usr/src/app/api/node_modules
        restart: unless-stopped
    # Front
    flutter:
        image: plugfox/flutter:stable-android
        build:
            dockerfile: front/Dockerfile
            context: .
            args:
                - VERSION=stable
    # DB
    db:
        image: mongo:5.0
        container_name: mongo
        environment:
            - MONGO_INITDB_ROOT_USERNAME=root
            - MONGO_INITDB_ROOT_PASSWORD=password
        restart: unless-stopped
        ports:
            - "27017:27017"
        volumes:
            - ./database/db:/data/db
            - ./database/dev.archive:/Databases/dev.archive
            - ./database/production:/Databases/production

    # remove in production
    mongo-express:
        image: mongo-express
        container_name: mexpress
        environment:
            - ME_CONFIG_MONGODB_ADMINUSERNAME=root
            - ME_CONFIG_MONGODB_ADMINPASSWORD=password
            - ME_CONFIG_MONGODB_URL=mongodb://root:password@mongo:27017/?authSource=admin
            - ME_CONFIG_BASICAUTH_USERNAME=mexpress
            - ME_CONFIG_BASICAUTH_PASSWORD=mexpress
        links:
            - db
        restart: unless-stopped
        ports:
            - "8081:8081"
    # prod:
    #     container_name: nestjs_api_prod
    #     image: nestjs-api-prod:1.0.0
    #     build:
    #         context: .
    #         target: production
    #         dockerfile: ./Dockerfile
    #     command: npm run start:prod
    #     ports:
    #         - 3000:3000
    #         - 9229:9229
    #     networks:
    #         - nesjs-network
    #     volumes:
    #         - .:/usr/src/app
    #         - /usr/src/app/node_modules
    #     restart: unless-stopped

networks:
    nesjs-network:
